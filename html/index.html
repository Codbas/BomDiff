<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bom Diff</title>
    <!-- #region favicon -->
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/webp;base64,UklGRjgDAABXRUJQVlA4WAoAAAAQAAAAHwAAHwAAQUxQSPIBAAANkHNb27G58s+LDxnbtj0T2+isyk5r21Zno7Nt27aT8Xx4n+LDk4iYAJS0UIHXjsof/wTepswJllB1+61Nr70wjQJVwiemXda0t55Kza8F3ppDfYBm0Qc8PZ76UwHhBDQFRPiECiDjuafKSoCknhr2vR/B/vTNSAV+IduvMbzciKsZ+HZdxr85cArX6Dbwb6UiU6hA3WlALRwleLJSR7YL8KgWUobm8WX7OaRDyoDjELIY2HUX+bI6qLwENsMKrR7+lusG3FGhesvgRmQ4XktF5QJHQPd7a/bBFGLTAKOuXnhoaoMfd6DX+LcGmBeXGG7enT7920XtCtwLD0npgKuW6AOgh2S29FlzGkhIAfIXBFQJsNlwq1o0MDcZsvUUlPz4DVGJNV9fvL9zvdIQoGhqaPueARA3aCNcnukAYWBoViA/Vijfb9k+n46dbIJSB3z9irfB8xMMbetOcOwtzQTfEGRLDLSaCwC/qhNB2KS6Ag8bXFQV+PNbJrIAOIprlB9w21emcQP8veamgxNs+5FUugG3zC7hPYDjDTLxqcARAH2UAW+2IdvCAd/uA+ZhJvi6BFm9M3DVAnHjnPBiiSKVEgPiiCmjSydB3cE9yLcR4Og/2CqovLhTR97SFgd6m7q35y9d8+F/qlvPaIiqqgYfvAVWUDggIAEAABAJAJ0BKiAAIAA+iTaVR6UjIiEwDACgEQlsAJ0zNDmfgH5AcnM9Hznfkvtm3jD+7dQDzAdADyZuAA8qr2H/20/Zn2gATF9ZRvAfV+tnoZH0AAD+6/XVYSM88kgs++W6BODt2j5pT5s4Ez//Vt0zP+5uFto6CpI4ZHj10/lq/kfbOe9p7v+m9bMmfKP+atWSf3CvH26CIh+xUBanxtPiz6xREXzok/Af9XHPJXMb4mPBo/1/ckP4jqwiNTPM/7mrbMFZKLngSQMrQmwb/zpBoW5UVfcUn5//7cf+TXyhNfvzuMh4o04gaO0giZAEwXLkcz5/8X4zfk58G5Pyn9HJBssm5h/o90rkArXFSXjRVvZOZ28cckkHwXd6OsYCqAAAAA==">
    <!-- #endregion -->
    <script>
    "use strict";
    let file1 = null;
    let file2 = null;
    let fileName1 = null;
    let fileName2 = null;
    let tableEmpty = true;
    let csvDiff = [[]];
    const dragCounters = new Map();

    const FILE_NAME_MAX_LENGTH = 23;

    window.addEventListener("load", ()=> {
        const dropContainers = document.getElementsByClassName("drop-container");
        const removeFileButtons = document.getElementsByClassName("remove-file");
        const uploadInputs = document.getElementsByTagName("input");
        const submitButton = document.getElementById("getDiffButton");
        const logo = document.getElementById("logo");
        const themeSwitch = document.getElementById("theme-switch-wrapper");
        const csvDownloadbutton = document.getElementById("csv-download-button");
        const copyTableButton = document.getElementById("copy-table-button");

        for (let elem of removeFileButtons) {
            elem.addEventListener("click", removeFile);
        }

        for (let elem of dropContainers) {
            elem.addEventListener("dragenter", handleDragEnter);
            elem.addEventListener("dragleave", handleDragLeave);
            elem.addEventListener("drop", dropHandler);
            elem.addEventListener("dragover", handleDragOver);
        }

        for (let elem of uploadInputs) {
            elem.addEventListener("change", handleFileUpload);
        }

        submitButton.addEventListener("click", compareBoms);
        logo.addEventListener("click", () => { location.reload() });
        themeSwitch.addEventListener("click", toggleTheme);
        csvDownloadbutton.addEventListener("click", downloadCSV);
        copyTableButton.addEventListener("click", copyTableToClipboard);

        document.body.addEventListener("dragover", handleDragOver);
        document.body.addEventListener("drop", (event) => {
            event.preventDefault();
        });
        
        // Icon png is inverted for dark theme
        setToggleThemeIconColor(getCookie("darkTheme") === "true");
    });



    /********************************************************************
     * 
     *                      Event Listeners
     * 
    *********************************************************************/

    async function compareBoms(event) {
        if (event.target.classList[0] === "disabled") {
            return;
        }

        const tableWrapper = document.getElementById("table-wrapper");
        const diffCard = document.getElementById("diff-card");
        const diffButtonsContainer = document.getElementById("diff-buttons-container");

        //tableWrapper.classList.remove("empty");
        //diffCard.classList.remove("empty");

        const bom1 = await csvToArray(file1);
        const bom2 = await csvToArray(file2);

        csvDiff = getBomDiff(bom1, bom2);
        if (csvDiff.length === 1) {
            if (csvDiff[0][0] === "Item") {
                tableWrapper.innerHTML = "BOMs are identical";
                diffButtonsContainer.classList.add("empty");
                setCsvNames(true);
                return;
            }

            tableWrapper.innerHTML = csvDiff[0][0]; // does this ever happen?
            console.log("INFO: it happened - line 98");
            return;
        }

        tableWrapper.innerHTML = "";
        diffButtonsContainer.classList.remove("empty");

        const table = arrayToTable(csvDiff);

        tableWrapper.innerHTML = table;
        addColorClassToNumberCells(tableWrapper);
        setCsvNames(false);
        tableWrapper.classList.remove("empty");
        diffCard.classList.remove("empty");
    }

    function removeFile(event) {
        const container = event.currentTarget.parentElement;
        clearTimeout(container._timeoutId);

        const submitButton = document.getElementById("getDiffButton");
        container.classList.remove("dropped");
        container.classList.remove("error");
        container.getElementsByTagName("p")[0].innerText = "Drag & Drop";

        clearFileContents(container);

        submitButton.classList.add("disabled");
    }

    function handleFileUpload(event) {
        const container = event.currentTarget.parentElement;
        clearTimeout(container._timeoutId);

        const submitButton = document.getElementById("getDiffButton");

        const file = event.target.files[0];

        if (!isCSV(file.name)) {
            displayInvalidFileError(container, truncateText(file.name, FILE_NAME_MAX_LENGTH));
            clearFileContents(container);
            submitButton.classList.add("disabled");
            return;
        }

        setFileContents(container, file);
        updateContainer(container, truncateText(file.name, FILE_NAME_MAX_LENGTH));

        if (file1 !== null && file2 !== null) {
            submitButton.classList.remove("disabled");
        }
    }

    function dropHandler(event) {
        event.preventDefault();

        const container = event.currentTarget;
        clearTimeout(container._timeoutId);

        const submitButton = document.getElementById("getDiffButton");
        
        dragCounters.set(container, 0); 
        container.classList.remove("drag-over");

        const file = event.dataTransfer.items[0].getAsFile();

        if (!isCSV(file.name)) {
            displayInvalidFileError(container, truncateText(file.name, FILE_NAME_MAX_LENGTH));
            clearFileContents(container);
            submitButton.classList.add("disabled");
            return;
        }

        setFileContents(container, file);
        updateContainer(container, truncateText(file.name, FILE_NAME_MAX_LENGTH));

        if (file1 !== null && file2 !== null) {
            submitButton.classList.remove("disabled");
        }
    }

    function handleDragEnter(event) {
        event.preventDefault();

        const container = event.currentTarget;
        const count = dragCounters.get(container) || 0;
        dragCounters.set(container, count + 1);

        if (count === 0) {
            container.classList.add("drag-over");
        }
    }

    function handleDragLeave(event) {
        event.preventDefault();

        const container = event.currentTarget;
        const count = dragCounters.get(container) || 0;

        if (count <= 1) {
            dragCounters.set(container, 0);
            container.classList.remove("drag-over");
        } else {
            dragCounters.set(container, count - 1);
        }
    }

    function handleDragOver(event) {
        event.preventDefault(); 
    }

    function downloadCSV(event) {
        if(csvDiff.length <= 1) {
            console.log("ERROR: Diff table is empty")
            return;
        }

        const copyIcon = document.getElementById("copy-icon");
        const csvDownloadbutton = document.getElementById("csv-download-button");
        const downloadCsvCheckmark = document.getElementById("download-csv-checkmark");
        const arrow = document.getElementById("arrow");
        const csvText = document.getElementById("csv-text");

        const csvContent = csvDiff.map(row =>
            row.map(value => 
                typeof value === "string" && value.includes(",")
                ? `"${value.replace(/"/g, '""')}"` 
                : value
            ).join(",")
            ).join("\n");

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "diff.csv";

            link.click();
            URL.revokeObjectURL(link.href);

            if (!downloadCsvCheckmark._timeoutId) {
                arrow.classList.remove("empty");
                csvText.classList.remove("empty");
                downloadCsvCheckmark.classList.add("empty");
            }

            arrow.classList.add("empty");
            csvText.classList.add("empty");
            downloadCsvCheckmark.classList.remove("empty");

            downloadCsvCheckmark.animate(
                [
                    { fontSize: "35px", transform: "translateY(-10px)" }, 
                    { fontSize: "20px", transform: "translateY(0px)" } 
                ],
                {
                    duration: 200,
                    easing: "ease-out",
                    fill: "forwards"
                }
        );

        if (downloadCsvCheckmark._timeoutId) {
            clearTimeout(downloadCsvCheckmark._timeoutId);
        }

        downloadCsvCheckmark._timeoutId = setTimeout(() => {
            downloadCsvCheckmark.classList.add("empty");
            arrow.classList.remove("empty");
            csvText.classList.remove("empty");
            downloadCsvCheckmark._timeoutId = null;
        }, 2000);
    }

    async function copyTableToClipboard(event) {
        if(csvDiff.length <= 1) {
            console.log("ERROR: Diff table is empty")
            return;
        }

        const copyIcon = document.getElementById("copy-icon");
        const copyTableButton = document.getElementById("copy-table-button");
        const copyCheckmark = document.getElementById("copy-checkmark");

        let copied = false;

        const tableText = csvDiff.map(row => row.join('\t')).join('\n');

        if (!copyCheckmark._timeoutId) {
            copyIcon.classList.remove("empty");
            copyCheckmark.classList.add("empty");
        }

        try {
            await navigator.clipboard.writeText(tableText)
                copied = true;
            } catch (error) {
                console.error('ERROR: unable to copy table to clipboard\n', err);
            } finally {
            if (copied) {
                copyIcon.classList.add("empty");
                copyCheckmark.classList.remove("empty");

                copyTableButton.animate(
                    [
                        { fontSize: "35px" }, 
                        { fontSize: "20px" } 
                    ],
                    {
                        duration: 200,
                        easing: "ease-out",
                        fill: "forwards"
                    }
                );

                if (copyCheckmark._timeoutId) {
                    clearTimeout(copyCheckmark._timeoutId);
                }
        
                copyCheckmark._timeoutId = setTimeout(() => {
                    copyCheckmark.classList.add("empty");
                    copyIcon.classList.remove("empty");
                    copyCheckmark._timeoutId = null;
                }, 2000);

            }
            else {
                console.log("ERROR: unable to copy diff table to clipboard");
            }
        }
    }


    /********************************************************************
     * 
     *              File upload, DOM update, file validation
     * 
    *********************************************************************/


    function toggleTheme() {
        const currentTheme = document.body.classList.contains("dark");
        const newThemeIsDark = !currentTheme;

        if (newThemeIsDark === true) {
            document.body.classList.add("dark");
            document.cookie = "darkTheme=true; path=/; max-age=31536000";
        }
        else {
            document.body.classList.remove("dark");
            document.cookie = "darkTheme=false; path=/; max-age=31536000";
        }

        setToggleThemeIconColor(newThemeIsDark);
    }

    function setToggleThemeIconColor(darkTheme) {
        const themeSwitch = document.getElementById("theme-switch");
        const copyIcon = document.getElementById("copy-icon");
        const arrow = document.getElementById("arrow");

        if (darkTheme) {
            themeSwitch.style.filter = "invert(100%)";
            copyIcon.style.filter = "brightness(4.5)";
            arrow.style.filter = "invert(1) brightness(0.7)";
        }
        else {
            themeSwitch.style.filter = "invert(0%)";
            copyIcon.style.filter = "brightness(1)";
            arrow.style.filter = "invert(0) brightness(0.7)";
        }
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);

        if (parts.length === 2) return parts.pop().split(';').shift();

        return null;
    }

    function setCsvNames(identical) {
        const csvNames = document.getElementById("csv-names");

        if (identical) {
            csvNames.innerText = "";
            return;
        }

        const csv1 = fileName1.slice(0, -4);
        const csv2 = fileName2.slice(0, -4);

        csvNames.innerText = `${csv1}   →   ${csv2}`;
    }

    function setFileContents(container, file) {
        if (container.id !== "dropContainer1" && container.id !== "dropContainer2") {
            console.log("Error: " + container.id + " is not a valid container");
            return;
        }

        if (container.id === "dropContainer1") {
            file1 = file;
            fileName1 = truncateText(file.name, FILE_NAME_MAX_LENGTH);
        }
        else {
            file2 = file;
            fileName2 = truncateText(file.name, FILE_NAME_MAX_LENGTH);
        }
    }

    function truncateText(text, maxLength) {
        if (text.length <= maxLength) {
            return text;
        }

        const leftSide = parseInt(maxLength / 2) - 1;
        const rightSide = leftSide + (text.length - maxLength) + 3;

        const leftString = text.substring(0, leftSide);
        const rightString = text.substring(rightSide, text.length);

        return leftString + "..." + rightString;

    }

    function updateContainer(container, fileName) {
        if (isCSV(fileName)) {
            container.classList.add("dropped");
            container.classList.remove("error");
            container.getElementsByTagName("p")[0].innerText = fileName;
        }
        else {
            container.classList.remove("dropped");
            container.classList.add("error");
            container.getElementsByTagName("p")[0].innerText = "Error: Not a CSV";
        }
    }

    function displayInvalidFileError(container, fileName) {
        updateContainer(container, fileName);

        if (container._timeoutId) {
            clearTimeout(container._timeoutId);
        }
    
        container._timeoutId = setTimeout(() => {
            container.classList.remove("error");
            container.getElementsByTagName("p")[0].innerText = "Drag & Drop";
            container._timeoutId = null;
        }, 5000);
    }

    async function csvToString(csv) {
        const text = await csv.text();
        return text;
    }

    function clearFileContents(container) {
        if (container.id === "dropContainer1") {
            file1 = null;
            fileName1 = null;
            return;
        }
            file2 = null;
            file2 = null;
    }

    function isCSV(fileName) {
        if (fileName.toLowerCase().endsWith(".csv")) {
            return true;
        }
        return false;
    }

    function formatNumberString(str, length) {
        const sign = str[0];
        const number = str.slice(1);
        return sign + number.padStart(length - 1, " ");
    }

    async function addColorClassToNumberCells(table) {
        let qtyIndex = -1;
        const headerCells = table.querySelectorAll("thead tr th");

        headerCells.forEach((cell, index) => {
            if (cell.textContent.trim().toLowerCase() === "quantity") {
                qtyIndex = index;
            }
        });

        if (qtyIndex === -1) {
            console.log("ERROR: Quantity index not found. Quantity column will not be colored.");
            return;
        }
        
        const rows = table.querySelectorAll("tbody tr");
        const width = 10;
        rows.forEach(row => {
            const cell = row.querySelectorAll("td")[qtyIndex];

            const qty = parseFloat(cell.textContent.trim());

            if (!isNaN(qty)) {
                if (qty > 0) {
                    cell.classList.add("positive");
                    cell.textContent = formatNumberString("+" + cell.textContent, width);
                }
                else {
                    cell.classList.add("negative");
                    cell.textContent = formatNumberString(cell.textContent, width);
                }
            }
        });

    }

    async function csvToArray(csv) {
        const text = await csvToString(csv);

        const rows = [];
        let inQuotes = false;
        let field = '';
        let row = [];

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];

            // fields are wrapped in quotes when they contain commas. Keep the commas
            if (inQuotes) {
                if (char === '"' && nextChar === '"') {
                    field += '"'; 
                    i++;
                } else if (char === '"') {
                    inQuotes = false;
                } else {
                    field += char;
                }
            } else {
                if (char === '"') {
                    inQuotes = true;
                } else if (char === ',') {
                    row.push(field);
                    field = '';
                } else if (char === '\n' || char === '\r') {
                    if (field || row.length > 0) {
                        row.push(field);
                        field = '';
                        rows.push(row);
                        row = [];
                    }
                    if (char === '\r' && nextChar === '\n') i++;
                } else {
                    field += char;
                }
            }
        }

        if (field || row.length > 0) {
            row.push(field);
            rows.push(row);
        }

        return rows;
    }

    function getIndexOfString(stringArr, arr) {
        if (typeof stringArr === "string") {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].toLowerCase() == stringArr.toLowerCase()) {
                    return i;
                }
            }
        }
        else {
            for (let i = 0; i < arr.length; i++) {
                if (stringArr.includes(arr[i].toLowerCase())) {
                    return i;
                }
            }
        }

        return -1;
    }

    function arrayToTable(arr) {
        let table = "<table><thead><tr>";

        for (let i = 0; i < arr[0].length; i++) {
            table += `<th>${arr[0][i]}</th>`;
        }

        table += "</tr></thead><tbody>";

        for (let i = 1; i < arr.length; i++) {
            table += "<tr>";
            for (let j = 0; j < arr[i].length; j++) {
                table += `<td>${arr[i][j]}</td>`;
            }
            table += "</tr>";
        }

        table += "</tbody></table>";

        return table;
    }


    /********************************************************************
     * 
     *                      Compare BOMs logic
     * 
    *********************************************************************/
    

    /* TODO:    * add check for unit of measure. 
                * Convert different units for comparison
                * Display Unit of measure after quantity
    */

    // TODO: Add option to select columns to compare

    function getBomDiff(bom1, bom2) {
        let diff = [["Item", "Quantity", "Description"]];
        let hasDescription = true;

        const itemStrings = ["item", "component name", "part"];
        const qtyStrings = ["quantity", "quantity per top level assembly"];

        const bom1ItemIndex = getIndexOfString(itemStrings, bom1[0]);
        const bom1QtyIndex = getIndexOfString(qtyStrings, bom1[0]);
        const bom1DescIndex = getIndexOfString("description", bom1[0]);
        const bom2ItemIndex = getIndexOfString(itemStrings, bom2[0]);
        const bom2QtyIndex = getIndexOfString(qtyStrings, bom2[0]);
        const bom2DescIndex = getIndexOfString("description", bom2[0]);

        if (bom1ItemIndex === -1 || bom1QtyIndex === -1 || bom2ItemIndex === -1 ||  bom2QtyIndex === -1) {
            diff[0][0] = "Error: Item or Quantity column not found";
            return diff;
        }

        if (bom1DescIndex === -1 || bom2DescIndex === -1) {
            console.log("INFO: Description column not found");
            hasDescription = false;
            diff[0].splice(2, 1);
        }

        const bom1Map = aggregateBOM(bom1, bom1ItemIndex, bom1QtyIndex, bom1DescIndex, hasDescription);
        const bom2Map = aggregateBOM(bom2, bom2ItemIndex, bom2QtyIndex, bom2DescIndex, hasDescription);

        // Compare bom1 to bom2
        for (const [item, { qty: qty1, desc }] of bom1Map.entries()) {
            const qty2 = bom2Map.has(item) ? bom2Map.get(item).qty : 0;
            const diffQty = qty2 - qty1;
            if (Math.abs(diffQty) >= 0.0001) {
                if (hasDescription) {
                    diff.push([item, Math.round(diffQty * 10000) / 10000, desc]);
                } else {
                    diff.push([item, Math.round(diffQty * 10000) / 10000]);
                }
            }
            bom2Map.delete(item);
        }

        // Remaining items in bom2
        for (const [item, { qty, desc }] of bom2Map.entries()) {
            if (hasDescription) {
                diff.push([item, Math.round(qty * 10000) / 10000, desc]);
            } else {
                diff.push([item, Math.round(qty * 10000) / 10000]);
            }
        }

        return diff;
    }


    function aggregateBOM(bom, itemIndex, qtyIndex, descIndex, hasDescription) {
        const map = new Map();

        for (let i = 1; i < bom.length; i++) {
            const item = bom[i][itemIndex];
            const qty = parseFloat(bom[i][qtyIndex]) || 0;
            const desc = hasDescription ? bom[i][descIndex] : "";

            if (map.has(item)) {
                map.get(item).qty += qty;
            } else {
                map.set(item, { qty: qty, desc: desc });
            }
        }
        return map;
    }


    </script>
    <style>
        :root {
            --bg-dark: hsl(0, 0%, 100%);
            --bg: hsl(0 0% 95%);
            --bg-light: hsl(0 0% 90%);
            --bg-light-inverted: hsl(0 0% 10%);
            --bg-lightest: hsl(0 0% 85%);
            --border: hsl(0 0% 70%);
            --border-disabled: hsl(0 0% 85%);
            --text: hsl(0 0% 5%);
            --text-muted: hsl(0 0% 30%);
            --text-disabled: hsl(0 0% 75%);
            --color-bg: hsl(120 50% 80%);
            --color-border: hsl(120, 50%, 60%);
            --color-text: hsl(120 50% 5%);
            --color-error-bg: hsl(0 50% 80%);
            --color-error-border: hsl(0 50% 60%);
            --color-error-text: hsl(0 50% 5%);

            --transition-delay: 0.1s;
            --border-radius: 5px;

            --dropbox-width: 175px;
            --dropbox-height: 100px;
        }

        body.dark {
            --bg-dark: hsl(0 0% 0%);
            --bg: hsl(0 0% 5%);
            --bg-light: hsl(0 0% 10%);
            --bg-light-inverted: hsl(0 0% 90%);
            --bg-lightest: hsl(0 0% 15%);
            --border: hsl(0 0% 30%);
            --border-disabled: hsl(0 0% 15%);
            --text: hsl(0 0% 95%);
            --text-muted: hsl(0 0% 70%);
            --text-disabled: hsl(0 0% 25%);
            --color-bg: hsl(120 40% 20%);
            --color-border: hsl(120, 40%, 40%);
            --color-text: hsl(120 40% 95%);
            --color-error-bg: hsl(0 50% 20%);
            --color-error-border: hsl(0 50% 40%);
            --color-error-text: hsl(0 50% 95%);
        }
        html, body {
            height: 100%;
            margin: 0;
        } body {
            font-family: Helvetica, Arial, monospace;
            color: var(--text-muted);
            background-color: var(--bg-dark);
        }

/*************           Header       ******************/
        #header {
            position: fixed;
            z-index: 1000;
            width: 100%;
            height: 55px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }
        #logo {
            transition: var(--transition-delay);
            margin-top: 5px;
            margin-left: 5px;
            padding: 5px;
            width: 35px;
            height: 35px;
            border-radius: 5px;
        }
        #logo:hover, #theme-switch-wrapper:hover {
            cursor: pointer;
            background: var(--bg-light);
        }
        #logo:active, #theme-switch-wrapper:active {
            background: var(--bg);
        }

        #theme-switch-wrapper {
            cursor: pointer;
            transition: var(--transition-delay);
            margin-top: 5px;
            margin-right: 25px;
            padding: 10px;
            float: right;
            width: 25px;
            height: 25px;
            border-radius: var(--border-radius);
            user-select: none;
            -webkit-user-select: none;
        }
        #theme-switch {
            width: 25px;
            height: 25px;
        }
/***************    End Header       ********************/


        #page-content {
            position: fixed;
            overflow-y: scroll;
            inset: 55px 0px 0px;
            width: 100%;
        }

        #upload-container {
            position: relative;
            margin-top: 100px;
            margin-left: auto;
            margin-right: auto;
            min-width: 475px;
            max-width: 525px;
            height: 200px;
            max-height: 200px;
        }

        .error {
            background:  var(--color-error-bg) !important;
            color: var(--color-error-text) !important;
            border-color: var(--color-error-border) !important;
        }

        .dropped {
            font-family: monospace;
            background:  var(--color-bg) !important;
            color: var(--color-text) !important;
            border-color: var(--color-border) !important;
        }
        .drag-over > .browse-label, .dropped > .browse-label, .error > .browse-label {
            opacity: 0;
            visibility: hidden;
        }
        .drag-over {
            background:  var(--bg-lightest) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }
        .drag-over > p, .dropped > p, .error > p {
            transition: var(--transition-delay);
            transform: translateY(-24px);
        }
        p {
            margin-top: 30px;
            user-select: none;
            -webkit-user-select: none;
            transition: var(--transition-delay);
        }
        .file-text { 
            white-space: nowrap;
        }

        .drop-container {
            transition: var(--transition-delay);
            padding: 15px;
            width: var(--dropbox-width);
            height: var(--dropbox-height);
            min-width: var(--dropbox-min-width);
            background: var(--bg);
            color: var(--text);
            border: solid 1px var(--border);
            text-align: center;
            border-radius: var(--border-radius);
        }

        .browse-label {
            margin-top: 8px;
            transition: var(--transition-delay);
            user-select: none;
            -webkit-user-select: none;
            background: var(--bg-light);
            display: inline-block;
            line-height: 25px;
            border-radius: var(--border-radius);
            height: 25px;
            width: 100px;
            border: 1px solid var(--border);
        }
        .browse-label:hover {
            cursor: pointer;
            background: var(--bg-lightest);
            border-color: var(--bg-lightest);

        }
        .browse-label:active {
            background: var(--bg-light);
        }

        .drop-container-label {
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 5px;
            user-select: none;
            -webkit-user-select: none;
        }
        .drop-wrapper {
            position: relative;
            margin: 10px;
        }
        #drop-wrapper1 {
            float: left;
        }
        #drop-wrapper2 {
            float: right;
        }

        .remove-file {
            transition: var(--transition-delay);
            width: 20px;
            height: 20px;
            line-height: 15px;
            font-size: 20px;
            font-weight: 200;
            display: none;
            user-select: none;
            -webkit-user-select: none;
            position: absolute;
            right: 5px;
            top: 28px;
            color: var(--text-muted);
        }
        .remove-file:hover {
            cursor: pointer;
            color: hsl(0 100% 45%) !important;
        }
        .remove-file:active {
            color: hsl(0 75% 40%) !important;
        }
        .dropped > div, .error > div {
            display: unset;
        }


/************ Get Diff Button     *******************/
        .disabled {
            background: var(--bg) !important;
            color: var(--text-disabled) !important;
            border-color: var(--border-disabled) !important;
        }
        #getDiffButton:hover:not(.disabled) {
            cursor: pointer;
            background: var(--bg-lightest);
            border-color: var(--bg-lightest);
        }
        #getDiffButton {
            transition: var(--transition-delay);
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            user-select: none;
            -webkit-user-select: none;
            line-height: 25px;
            width: 100px;
            height: 25px;
            margin-top: 25px;
            background: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);

        }

        #getDiffButton:active:not(.disabled) {
            background: var(--bg-light) !important;
        }

        .empty {
            display: none !important;
        }
        .populated {
            display: unset;
        }
/************ End Get Diff Button     ****************/

        #diff-wrapper {
            margin-top: 50px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

/************   Table Copy & CSV Download buttons     ****************/
        #diff-buttons-container {
            display: flex;
            margin-left: auto;
            margin-right: 0;
            width: fit-content;
            height: 25px;
            user-select: none;
            -webkit-user-select: none;
        }

        #arrow {
            width: 8px;
            height: 9px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 3px;
            margin-bottom: 3px;
        }
        #csv-text {
            font-size: 8px;
            font-family: Helvetica, Arial;
            font-weight: bold;
        }

        #csv-download-button {
            display: flex;
            flex-direction: column;
            transition: var(--transition-delay);

            text-align: center;
            user-select: none;
            -webkit-user-select: none;
            width: 25px;
            height: 25px;
            background: var(--bg-light);
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
        }
        #csv-download-button:hover, #copy-table-button:hover {
            cursor: pointer;
            background: var(--bg-lightest);
            border-color: var(--bg-lightest);
        }
        #csv-download-button:active, #copy-table-button:active {
            background: var(--bg-light);
        }

        #copy-icon {
            width: 16px;
            height: 16px;
            filter: brightness(4.5);
        }
        #copy-checkmark, #download-csv-checkmark {
            color: rgb(0, 160, 0);
        }
        #download-csv-checkmark {
            position: absolute;
            align-self: center;
        }

        #copy-table-button {
            margin-left: 10px;
            background: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            transition: var(--transition-delay);
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--border-radius);
        }
/************   END Table Copy & CSV Download buttons     ****************/


/************       Diff Card        ****************/
        #diff-card {
            display: block;
            align-self: center;
            margin: 10px auto 0 auto;
            padding: 10px 25px 25px 25px;
            margin-bottom: 25px;
            width: fit-content;
            border-radius: var(--border-radius);
            border: solid 1px var(--border);
            background: var(--bg);
        }
        #diff-card.empty {
            display: none;
        }

        #csv-names {
            color: var(--text-muted);
            text-align: center;
            font-family: monospace;
            font-size: 16px;
            font-weight: 700;
            white-space: pre;
        }
/************     End Diff Card      ****************/


/****************     Table       *********************/
        #table-wrapper {
            margin-top: 20px;
        }
        #table-wrapper:empty {
            display: none;
        }

        table {
            margin-left: auto;
            margin-right: auto;
            border-collapse: collapse;
            border: none;
            font-family: monospace;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid var(--border);
        }
        table th {
            border-top: none;
            color: var(--text);
        }
        th:first-child, td:first-child {
            border-left: none;
        }
        th:last-child, td:last-child {
            border-right: none;
        }
        table tr:last-child td {
            border-bottom: none;
        }

        tbody td:first-child {
            padding-left: 10px;
            padding-right: 10px;
            text-align: left;
            min-width: 120px;
        }
        tbody td:nth-child(2) {
            min-width: 80px;
            text-align: right;
            padding-right: 10px;
            padding-left: 10px;
            white-space: pre;
        }
        tbody td:nth-child(3) {
            padding-left: 10px;
            text-align: left;
            min-width: 240px;
        }

        .positive {
            color: rgb(0, 160, 0);
        }
        .negative {
            color: red;
        }
/************ End Table   *******************/
    </style>
</head>


<body class="">

    <!-- Must apply theme as body is loaded to avoid FOUC -->
    <script>
        "use strict";
        const value = `; ${document.cookie}`;
        const parts = value.split("; darkTheme=");
        let darkTheme = -1;

        if (parts.length === 2) {
            darkTheme = parts.pop().split(';').shift();
        }

        if (darkTheme === "true") {
            document.body.classList.add("dark");
        }
        else {
            document.body.classList.remove("dark");
        }
    </script>

    <nav id="header">
        <!-- #region logo image -->
        <img id="logo" draggable="false" src="data:image/webp;base64, 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">
        <!-- #endregion -->
        <!-- #region light/dark theme image -->
        <div id="theme-switch-wrapper">
        <img id="theme-switch" draggable="false" src="data:image/webp;base64, UklGRlwDAABXRUJQVlA4WAoAAAAQAAAAPwAAPwAAQUxQSAkDAAABkEbb2vE4N8nYqG3btm3btm3btm3btm23Y8+XWwTvk1Q/I8KB20iK5OreY6aeewKEKfvuQQ7YNdPJnva1gBxoX/P/pzim8bPdxZzTeKvo/e5IZgXDyZYKPKZ92OKn8FgOkxcUKsnEob4KPdvIwOywnjahagWotEau8lBg6GZSNuoNcaESvdXSxc1fv9eI0QNalUrupNKCSm/Kp8rCm4EaSTL82fZ2KUy5zTRrSY03eXhNTkbSYoyPRib/pXi4aQsqILLjT7l3RJOMfHJo6aYomuV2Y0cg69PYdZIGDEXLu0HX+DnJVwuqJHVBwRCaJ3yaL3S5qvlCHEP3IPLb9Ew6AChsCbk+PmySjmHk1fI6QAHX+dhCla/k/jSAGk52kEt1izyUBMrCGsjPNIu8kxHqeCOpVMEvDK0NCQ4W0i8gVzvJ3Esik/oFA4pCRmsu01zjHhchbjCILCS7QuphItGXylkGFRALKWT1pXI0jeGnpM/4OLGY1gCAwezO6lF8zd49v7J3Y0kg8yde8BJjV6DkRrM7u6b4WZrniCtyBfC4q1x/uB6hec4uijKaRpvvgBxfecpdrjcc5mtG00Qt8q3SuNGvNK7uD6R7x+t+cu0A/+pmd7aKLywn7h2+TSsWVRmCOO1hVFWxT1kgyUhystg5L5HSYbyVQGoSRHzOMbadUHAxyNLVyOtJZHa7CSW8Rk5zkAitCmkaRzKstcQKJzGXxeTnBurupIc8SU6QXzo5K/pYCbZI5stk5JL0Sr41hW2S6TjJJ8MyOQAoaNGbBpDzbNc7PpB4YQTJt5u7l8lQJ9SCM0UBx/qD04mHoiEAnBtc0kgy4tNHzfzYkQkAFAzg+czSmWqAyV2I1/5EMC0k+u4E009rvq8qs5nyTOVZZMCWqy/ef3x99+Dkmubf9YauodZLNJI5+CZPnzFVPBeV4U7t2kQTnU1KN8Ko1onjK9bxuNY5H1Lrsvcv51SrgGywnjpn5saDdbPJPiqzSbtz45W+PdwdbLhu8zD8V63b7L9u/t3X7Xb/3wAAVlA4ICwAAABwAwCdASpAAEAAPj0ejkUiIaERBAAgA8S0gAAIG6moArxC3IAA/v4G0AAAAA==">
        </div>
        <!-- #endregion -->
    </nav>
    <div id="page-content"> 
        <div id="upload-container">
            <div class="drop-wrapper" id="drop-wrapper1">
            <div class="drop-container-label">CSV 1</div>
                <div id="dropContainer1" class="drop-container">
                    <div class="remove-file" id="removeFile1">x</div>
                    <label class="browse-label" for="file1">Browse</label>
                    <input type="file" multiple="false" accept=".csv" style="display:none;" id="file1" name="file1">
                    <p class="file-text">Drag & Drop</p>
                </div>
                </div>
                <div class="drop-wrapper" id="drop-wrapper2">
            <div class="drop-container-label">CSV 2</div>
                <div id="dropContainer2" class="drop-container">
                    <div class="remove-file" id="removeFile2">x</div>
                    <label class="browse-label" for="file2">Browse</label>
                    <input type="file" multiple="false" accept=".csv" style="display:none;" id="file2" name="file2">
                    <p class="file-text">Drag & Drop</p>
                </div>
            </div>
        </div>
        <div id="getDiffButton" class="disabled">Get Diff</div>
            <div id="diff-wrapper">
            <div id="diff-buttons-container" class="empty">
                <div id="csv-download-button"><div id="download-csv-checkmark" class="empty">✔</div><img id="arrow" draggable="false" src="data:image/webp;base64, UklGRrAAAABXRUJQVlA4WAoAAAAQAAAADwAADwAAQUxQSHIAAAABcFNr29O8lNQ1GEACCpi6gRQPOEhxkBEXxAQOUua+cpj73/8pAiJiAiCeCSHkuoL6r/hpkkQX4bmOk9TPqrZpemFsmrbKJvuWaLb7CZb5qBrzJQCnUBUORLeUlS7k3kN4eFAHP0J+AXR3db2DtnU6WTJWUDggGAAAADABAJ0BKhAAEAACADQlpAADcAD++/1QAA=="></img><span id="csv-text">CSV</span></div>
                <div id="copy-table-button"><div id="copy-checkmark" class="empty">✔</div><img id="copy-icon" draggable="false" src="data:image/webp;base64, UklGRuwBAABXRUJQVlA4WAoAAAAQAAAAFwAAFwAAQUxQSCYBAAABkLNtm2nXC/q+yY7NyrZtp3VSJq3tVh1X0por/0AHlbtUxzY7r28mnJkdERMAAIC1p1yciTMhxJkQ4k0HgjT916fNVc21R9Qmi68LcWBSvO757gFeCxpdVk5FIgDg4RsGADEfyCLLIouIvueiCg/+Nni4Sz2env3IRdWL2wzk7LE4+5GLMvbmEBV4ws/Ej2ymg9cBM95xIU4dVKxo1zRNc9EJneOT9iwPjTki4vQ3DADQIE8N16KSkpKSeLQLAdV2sJS5eWUF0zOIy+nQDr/mVmWIHgKqAbVY2Mi4fCydGeR1+wXKVoiIEyeyjpnB2/6aiuDeAXl/MjMEfx8NEgRAOQAafDIQAAAfvvNEXdudnzaQtvNHa6uaD2gWZdj5Rpxpfp22wXVWUDggoAAAAJAEAJ0BKhgAGAA+kUKcSiWjoqGoCACwEglpAAAudkuSAlYPoKwfUa+apssagAD++E63N/34JWEaxIiAhE46lHxhL8OhWerJG1iHO3NUFNPVOUOufst6HKDYndyxfk/h+3+xTqpuePwhjE9FIH9KH84znhh84IE7XdTWdBUuxoQgSzN6/d7MxmTZrbv3hljaoS2bv/j5tlrPuQdEv8YAAAA="></div>
            </div>
            <div id="diff-card" class="empty">
                <div id="csv-names"></div>
                <div id="table-wrapper" class="empty"></div>
            </div>
        </div>
    </div>
</body>
</html>